# ğŸ¥ Medical-RAG-System: åŸºäº Qwen2.5 ä¸ Huatuo-26M çš„åŒ»ç–—æ™ºèƒ½é—®ç­”ç³»ç»Ÿ

## ğŸ“– é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ„å»ºäº†ä¸€ä¸ªé¢å‘ä¸­æ–‡åŒ»ç–—é¢†åŸŸçš„ **æ£€ç´¢å¢å¼ºç”Ÿæˆ (RAG)** é—®ç­”ç³»ç»Ÿã€‚é’ˆå¯¹é€šç”¨å¤§æ¨¡å‹åœ¨åŒ»ç–—é¢†åŸŸå®¹æ˜“äº§ç”Ÿå¹»è§‰ã€ç¼ºä¹ä¸“ä¸šçŸ¥è¯†çš„é—®é¢˜ï¼Œæœ¬ç³»ç»Ÿåˆ©ç”¨ **Huatuo-26M-Lite** åŒ»ç–—é—®ç­”æ•°æ®é›†æ„å»ºæœ¬åœ°å‘é‡çŸ¥è¯†åº“ï¼Œç»“åˆ **BGE-M3** åµŒå…¥æ¨¡å‹å’Œ **Qwen-2.5-7B-Instruct** å¤§æ¨¡å‹ï¼Œå®ç°äº†åŸºäºè¯æ®çš„ä¸“ä¸šåŒ»ç–—é—®ç­”ã€‚

æ­¤å¤–ï¼Œæœ¬é¡¹ç›®è¿˜å¼•å…¥äº† **LoRA (Low-Rank Adaptation)** å¾®è°ƒæŠ€æœ¯ï¼Œè¿›ä¸€æ­¥æå‡äº†æ¨¡å‹åœ¨åŒ»ç–—æŒ‡ä»¤éµå¾ªå’Œä¸“ä¸šæœ¯è¯­è¡¨è¾¾ä¸Šçš„å‡†ç¡®æ€§ï¼Œå¹¶ä½¿ç”¨ **DeepSeek-V3 API** å®ç°äº†è‡ªåŠ¨åŒ–çš„å®¢è§‚è¯„ä¼°ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

* **ğŸ›¡ï¸ å‚ç›´é¢†åŸŸ RAG**ï¼šåŸºäº ChromaDB + BGE-M3 æ„å»ºæœ¬åœ°å‘é‡åº“ï¼Œæ”¯æŒé•¿æ–‡æœ¬æ£€ç´¢ï¼Œæœ‰æ•ˆå‡å°‘å¹»è§‰ã€‚
* **ğŸ©º åŒ»ç–—å¾®è°ƒ (SFT)**ï¼šä½¿ç”¨ LLaMA-Factory å¯¹ Qwen-2.5 è¿›è¡Œ LoRA å¾®è°ƒï¼Œä½¿å…¶å…·å¤‡â€œåŒ»ç”Ÿâ€èˆ¬çš„ä¸“ä¸šå£å»ã€‚
* **ğŸ“š å¯è§£é‡Šæ€§å¼•ç”¨**ï¼šåœ¨å›ç­”ä¸­è‡ªåŠ¨å±•ç¤ºæ£€ç´¢åˆ°çš„å‚è€ƒæ¥æºï¼ˆSource Evidenceï¼‰åŠç›¸ä¼¼åº¦å¾—åˆ†ã€‚
* **ğŸ¤– è‡ªåŠ¨åŒ–è¯„ä¼°**ï¼šæ„å»ºäº†åŸºäº LLM-as-a-Judge (DeepSeek) çš„è¯„ä¼°æµæ°´çº¿ï¼Œé‡åŒ–å‡†ç¡®ç‡ä¸å¹»è§‰ç‡ã€‚
* **ğŸ’» å…¨æœ¬åœ°åŒ–éƒ¨ç½²**ï¼šæ”¯æŒæ¨¡å‹æƒé‡ä¸æ•°æ®é›†çš„å…¨æœ¬åœ°åŒ–åŠ è½½ã€‚

---

## ğŸ› ï¸ æŠ€æœ¯æ¶æ„

| ç»„ä»¶           | é€‰å‹                     | è¯´æ˜                                       |
| :------------- | :----------------------- | :----------------------------------------- |
| **LLM åŸºåº§**   | Qwen/Qwen2.5-7B-Instruct | æ”¯æŒ 32k é•¿ä¸Šä¸‹æ–‡ï¼ŒæŒ‡ä»¤è·Ÿéšèƒ½åŠ›å¼º          |
| **Embedding**  | BAAI/bge-m3              | æ”¯æŒå¤šè¯­è¨€ã€é•¿æ–‡æœ¬ (8192 tokens)           |
| **å‘é‡æ•°æ®åº“** | ChromaDB                 | æŒä¹…åŒ–å­˜å‚¨ï¼Œè½»é‡çº§                         |
| **åº”ç”¨æ¡†æ¶**   | LlamaIndex               | è´Ÿè´£ RAG æµç¨‹ç¼–æ’ (Retrieval & Generation) |
| **å¾®è°ƒæ¡†æ¶**   | LLaMA-Factory            | å®ç°é«˜æ•ˆ LoRA å¾®è°ƒ                         |
| **å‰ç«¯ç•Œé¢**   | Streamlit                | äº¤äº’å¼ Web UIï¼Œæ”¯æŒå¤šè½®å¯¹è¯                |
| **è¯„ä¼°è£åˆ¤**   | DeepSeek-V3 (API)        | ç”¨äºè‡ªåŠ¨åŒ–è¯„åˆ† (Accuracy, Hallucination)   |

---

## ğŸ“‚ é¡¹ç›®ç›®å½•ç»“æ„

```text
.
â”œâ”€â”€ app.py                      # Streamlit å‰ç«¯ä¸»ç¨‹åº
â”œâ”€â”€ build_vector_db.py          # å‘é‡æ•°æ®åº“æ„å»ºè„šæœ¬
â”œâ”€â”€ verify_db.py                # æ•°æ®åº“å®Œæ•´æ€§ä¸æ£€ç´¢èƒ½åŠ›éªŒè¯è„šæœ¬
â”œâ”€â”€ evaluate.py   				# è‡ªåŠ¨åŒ–è¯„ä¼°è„šæœ¬
â”œâ”€â”€ download_model.py           # æ¨¡å‹ä¸‹è½½è„šæœ¬
â”œâ”€â”€ download_dataset.py         # æ•°æ®é›†ä¸‹è½½è„šæœ¬
â”œâ”€â”€ download_qwen.py            # qwenæ¨¡å‹ä¸‹è½½è„šæœ¬
â”œâ”€â”€ convert_data.py           	# å¾®è°ƒæ•°æ®æ ¼å¼è½¬æ¢
â”œâ”€â”€ requirements.txt            # é¡¹ç›®ä¾èµ–åº“åˆ—è¡¨
â”œâ”€â”€ README.md                   # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ chroma_db/                  # [è‡ªåŠ¨ç”Ÿæˆ] å‘é‡æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ BAAI/                       # [è‡ªåŠ¨ç”Ÿæˆ] æœ¬åœ° Embedding æ¨¡å‹æƒé‡
â”œâ”€â”€ Qwen/                       # [è‡ªåŠ¨ç”Ÿæˆ] æœ¬åœ° LLM æ¨¡å‹æƒé‡
	â”œâ”€â”€ Qwen-2.5-7B/            # [è‡ªåŠ¨ç”Ÿæˆ] æœ¬åœ° LLM åŸºåº§æ¨¡å‹æƒé‡
	â””â”€â”€ Qwen-Medical-Merged/    # [è‡ªåŠ¨ç”Ÿæˆ] LoRA å¾®è°ƒååˆå¹¶çš„æ¨¡å‹
```

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. ç¯å¢ƒå‡†å¤‡

æ¨èä½¿ç”¨ Conda åˆ›å»ºç‹¬ç«‹ç¯å¢ƒï¼š

```bash
conda create -n medical_rag python=3.12
conda activate medical_rag
pip install -r requirements.txt
```

### 2. èµ„æºä¸‹è½½

ä¸ºäº†è§£å†³ HuggingFace è¿æ¥ä¸ç¨³å®šçš„é—®é¢˜ï¼Œæœ¬é¡¹ç›®æä¾›äº†åŸºäº ModelScope å’Œ HF é•œåƒç«™çš„ä¸‹è½½è„šæœ¬ï¼Œè¯·ä¾æ¬¡è¿è¡Œï¼š

```bash
# 1. ä¸‹è½½ BGE-M3 Embedding æ¨¡å‹ (è‡³ ./BAAI ç›®å½•)
python download_model.py

# 2. ä¸‹è½½ Huatuo-26M-Lite æ•°æ®é›† (è‡³ ./Huatuo26M-Lite ç›®å½•)
python download_dataset.py

# 3. ä¸‹è½½ Qwen-2.5-7B æ¨¡å‹
python download_qwen.py
```

### 3. æ„å»ºå‘é‡çŸ¥è¯†åº“

å°†åŒ»ç–—æ•°æ®é›†å…¨é‡å‘é‡åŒ–å¹¶å­˜å…¥ ChromaDBï¼š

```bash
python build_vector_db.py
```

> **æ³¨æ„**ï¼šè„šæœ¬å·²é…ç½® `MAX_DOCS = None` è¿›è¡Œå…¨é‡æ„å»ºï¼Œè¿™å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼ˆå–å†³äºæ˜¾å¡æ€§èƒ½ï¼‰ã€‚æ„å»ºå®Œæˆåï¼Œå»ºè®®è¿è¡Œ `python verify_db.py` éªŒè¯æ•°æ®åº“çŠ¶æ€ã€‚

### 4. å¯åŠ¨ Web åº”ç”¨

```bash
streamlit run app.py
```

å¯åŠ¨åï¼Œè®¿é—®ç»ˆç«¯æ˜¾ç¤ºçš„åœ°å€ (ä¾‹å¦‚ `http://localhost:8501`) å³å¯å¼€å§‹å¯¹è¯ã€‚

------

## ğŸ”§ æ¨¡å‹å¾®è°ƒ (LoRA Fine-tuning)

æœ¬é¡¹ç›®é€šè¿‡å¾®è°ƒè¿›ä¸€æ­¥æå‡äº†æ¨¡å‹çš„é¢†åŸŸé€‚é…èƒ½åŠ›ã€‚

1. **æ•°æ®æ ¼å¼è½¬æ¢**ï¼š

   å°† Huatuo QA æ•°æ®é›†è½¬æ¢ä¸º Alpaca æŒ‡ä»¤å¾®è°ƒæ ¼å¼ï¼š

   ```bash
   python convert_data.py
   ```

   *(è¾“å‡ºæ–‡ä»¶: `medical_sft_data.json`)*

2. **å¯åŠ¨ LLaMA-Factory**ï¼š

   ```bash
   llamafactory-cli webui
   ```

   - **Dataset**: åœ¨ `dataset_info.json` ä¸­æ³¨å†Œ `medical_sft` (æ³¨æ„æ·»åŠ  `"formatting": "alpaca"`)ã€‚
   - **Template**: é€‰æ‹© `qwen`ã€‚
   
3. **æ¨¡å‹åˆå¹¶ (Export)**ï¼š

   è®­ç»ƒå®Œæˆåï¼Œåœ¨ WebUI ä¸­ä½¿ç”¨ Export åŠŸèƒ½ï¼Œå°† LoRA æƒé‡ä¸åŸºåº§æ¨¡å‹åˆå¹¶ï¼Œå¯¼å‡ºè‡³ Qwen-Medical-Merged ç›®å½•ã€‚

------

## ğŸ”— å‚è€ƒèµ„æ–™

- [Huatuo26M-Lite](https://huggingface.co/datasets/FreedomIntelligence/Huatuo26M-Lite)
- [LlamaIndex Documentation](https://docs.llamaindex.ai/)
- [LLaMA-Factory](https://github.com/hiyouga/LLaMA-Factory)
- [DeepSeek API](https://platform.deepseek.com/)
- [ModelScope](https://modelscope.cn/)